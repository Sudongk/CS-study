# TLB (Translation Look-aside Buffer)

- `주소변환장치`로 `가상주소`를 `물리주소`로 변환하는데 사용되는 캐시 메모리

- `페이지테이블`의 일부를 캐싱하여 `가상주소`를 `물리주소`로 변환하는데 사용

- `TLB`를 사용하면 `페이지테이블`에 접근하는 시간을 줄일 수 있어 성능 향상에 도움이 됨

- `TLB`의 크기가 작을수록 `TLB 미스`가 발생할 확률이 높아지므로 성능이 저하됨

<br>

## 목적

- `페이지테이블`을 사용하여 `가상주소`를 `물리주소`로 변환하는 과정에서 발생하는 지연을 줄이기 위해 사용

<br>

## 동작

![](/OS/img/os_tlb_1.svg)

1. **_TLB에 가상주소가 있는지 확인_**
   - CPU 코어가 요청한 가상주소를 TLB에 검색
   - TLB에 가상주소가 있는 경우 `TLB 히트`로 물리주소를 즉시 얻을 수 있음

2. **_TLB에 가상주소가 없는 경우_**
    - TLB에 가상주소가 없는 경우 `TLB 미스`로 `페이지테이블`에 접근
    - `페이지테이블`에서 가상주소에 해당하는 물리주소를 찾아 TLB에 저장

3. **_TLB에 물리주소 저장_**
    - `페이지테이블`에서 물리주소를 찾아 TLB에 저장
    - 다음부터는 TLB에 저장된 물리주소를 사용하여 가상주소를 물리주소로 변환

4. **_TLB에 물리주소가 있는 경우_**
    - TLB에 물리주소가 있는 경우 `TLB 페이지 히트`로 물리주소를 즉시 얻을 수 있음

5. **_TLB에 물리주소가 없는 경우_**
    - TLB에 물리주소가 없는 경우 `TLB 페이지 미스`로 `페이지테이블`에 접근
    - `페이지테이블`에서 물리주소를 찾아 TLB에 저장

<br>

## 구조

- **_VPN(VPFS Virtual Page Frame Number)_**
  - TLB KEY
  - CPU 코어가 요청한는 가상주소(Virtual Address)는 `VPN`과 `VPO(offset)`로 구성
  - TLB 에서는 코어에서 요청한 가상주소에서 `VPN`을 추출해 내부 검색
- **_PPN(PPFN Physical Page Frame Number)_**
  - `VPN`과 1:1 대응되는 TLB VALUE
  - 코어가 요청한 가상주소에 해당하는 페이지의 주기억장치 주소를 저장
  - `PFO(offet)`와 결합해 주기억창지 주소 완성
- **_other bits_** 상태관리비트들
  - valid
    - hit/miss 여부를 표시
    - 시스템 시작시 invalid 로 초기화됨
  - protection
    - `TLB` 페이지 접근 방식에 대한 표시, read/write/execute 에 대한 상태 표시
    - 일종의 보호 비트
  - **_ASID(Address Space ID)_**
    - 단일 프로세스 환경
      - VPN 충돌이 일어나지 않아 사용되지 않음
    - 다중 프로세스 환경
      - `TLB`가 하나인 경우 프로세스가 `TLB`에 접근하려 할 때 충돌 방지목적으로 프로세스 별 ID 부여하고 ID 별로 VPN 을 관리하게 됨.
      - `ASID`가 등장하기 전에는 새로운 프로세스가 `TLB`에 접근시 매번 초기화 하는 방법을 사용했으나 큰 오버헤드 발생으로 고안됨.
  - dirty
    - 페이지가 `TLB`에 적재된 이후 수정 여부를 나타내는 비트

> `TLB`에 코어가 요청한 페이지가 없을 경우 페이지 주기억장치 내부 페이지테이블 탐색하고 
> 페이지 로드과정을 거친 후 `TLB` 정보를 갱신 한다.

<br>

### TLB 히트, 미스, 페이지 히트 미스의 경우 속도 차이

페이지 로드에는 TLB 히트로 즉시 페이지 로드가 가능한 경우 수십 클럭이 소모되지만,
TLB 미스로 페이지 테이블에 접근해야 하는 페이지 폴트의 경우에 비해 수십만 ~ 수백만 클럭이 소모되므로 수만 ~ 수십만 배의 속도 차가 발생 할 수 있다고 볼 수 있습니다.

- **_TLB 히트_**
  - TLB에 가상주소가 있는 경우
  - 즉시 물리주소를 얻을 수 있어 속도가 빠름

- **_TLB 미스_**
    - TLB에 가상주소가 없는 경우
    - 페이지테이블에 접근해 물리주소를 찾아 TLB에 저장
    - 속도가 느림

- **_TLB 페이지 히트_**
    - TLB에 물리주소가 있는 경우
    - 즉시 물리주소를 얻을 수 있어 속도가 빠름

- **_TLB 페이지 미스_**
    - TLB에 물리주소가 없는 경우
    - 페이지테이블에 접근해 물리주소를 찾아 TLB에 저장
    - 속도가 느림

